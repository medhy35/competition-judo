<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Historique Tatami</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body class="bg-light">

<div class="container py-4">
    <h1 class="text-center mb-4">ğŸ“œ Historique par Tatami</h1>

    <div class="mb-3">
        <label for="tatamiSelect" class="form-label">SÃ©lectionner un tatami :</label>
        <select id="tatamiSelect" class="form-select"></select>
    </div>

    <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark">
        <tr>
            <th>â± Heure</th>
            <th>ğŸ‘¹ Rouge</th>
            <th>ğŸ”µ Bleu</th>
            <th>âš–ï¸ CatÃ©gorie</th>
            <th>ğŸ¥‡ Gagnant</th>
            <th>ğŸ Ã‰tat</th>
            <th>ğŸ“Š Score</th>
        </tr>
        </thead>
        <tbody id="historiqueBody"></tbody>
    </table>
</div>

<script type="module">
    async function fetchJson(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
        return res.json();
    }

    async function chargerTatamis() {
        const tatamis = await fetchJson('/api/tatamis');
        const select = document.getElementById('tatamiSelect');
        select.innerHTML = "";

        tatamis.forEach(t => {
            const option = document.createElement('option');
            option.value = t.id;
            option.textContent = t.nom || `Tatami ${t.id}`;
            select.appendChild(option);
            console.log("Tatami sÃ©lectionnÃ© :", t);
            console.log("Combats associÃ©s :", t.combatsIds);

        });
        console.log("Tatamis chargÃ©s :", tatamis);
        if (tatamis.length > 0) {
            select.value = tatamis[0].id;
            chargerHistorique(tatamis[0].id);




        }
    }

    async function chargerHistorique(tatamiId) {
        const tatamis = await fetchJson('/api/tatamis');
        const combats = await fetchJson('/api/combats');
        const combattants = await fetchJson('/api/combattants');

        const t = tatamis.find(x => x.id === parseInt(tatamiId));
        if (!t) return;

        const tbody = document.getElementById("historiqueBody");
        tbody.innerHTML = "";

        for (const combatId of t.combatsIds || []) {
            const combat = combats.find(c => c.id === combatId);
            if (!combat || combat.etat !== "terminÃ©") continue;

            const rouge = typeof combat.rouge === "object" ? combat.rouge : combattants.find(c => c.id === combat.rouge);
            const bleu  = typeof combat.bleu  === "object" ? combat.bleu  : combattants.find(c => c.id === combat.bleu);

            const gagnant =
                combat.ipponRouge || (combat.wazariRouge >= 2)
                    ? "Rouge"
                    : combat.ipponBleu || (combat.wazariBleu >= 2)
                        ? "Bleu"
                        : (combat.wazariRouge > combat.wazariBleu)
                            ? "Rouge"
                            : (combat.wazariBleu > combat.wazariRouge)
                                ? "Bleu"
                                : "Ã‰galitÃ©";

            const row = document.createElement("tr");
            row.innerHTML = `
        <td>${new Date(combat.fin || Date.now()).toLocaleTimeString()}</td>
        <td>${rouge?.nom || 'Inconnu'}</td>
        <td>${bleu?.nom  || 'Inconnu'}</td>
        <td>${rouge?.poids || '-'}</td>
        <td><strong class="text-${gagnant === 'Rouge' ? 'danger' : gagnant === 'Bleu' ? 'primary' : 'secondary'}">${gagnant}</strong></td>
        <td>${combat.etat}</td>
        <td>
          R: ${combat.wazariRouge || 0}W / ${combat.penalitesRouge || 0}S<br />
          B: ${combat.wazariBleu || 0}W / ${combat.penalitesBleu || 0}S
        </td>
      `;
            tbody.appendChild(row);
        }
    }

    document.getElementById("tatamiSelect").addEventListener("change", e => {
        chargerHistorique(e.target.value);
    });

    window.addEventListener("DOMContentLoaded", () => {
        chargerTatamis();
    });
</script>

</body>
</html>
