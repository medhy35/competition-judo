<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestion Mode 1 – Équipes & Combattants</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container py-4">
    <h2 class="mb-4 text-center">Gestion des Équipes & Combattants</h2>

    <!-- Équipes -->
    <section class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Équipes</h4>
            <button class="btn btn-primary" id="btn-ajouter-equipe" data-bs-toggle="modal" data-bs-target="#modalEquipe">
                <i class="fas fa-plus"></i> Ajouter une équipe
            </button>
        </div>
        <ul class="list-group" id="liste-equipes"></ul>
    </section>

    <!-- Combattants -->
    <section>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Combattants</h4>
            <button class="btn btn-primary" id="btn-ajouter-combattant" data-bs-toggle="modal" data-bs-target="#modalCombattant" disabled>
                <i class="fas fa-plus"></i> Ajouter un combattant
            </button>
        </div>
        <select class="form-select mb-3" id="select-equipes-filter">
            <option value="">-- Sélectionner une équipe --</option>
        </select>
        <ul class="list-group" id="liste-combattants"></ul>
    </section>
</div>

<!-- Modal Equipe -->
<div class="modal fade" id="modalEquipe" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" id="formEquipe">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter une équipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input class="form-control mb-2" id="inputEquipeId" placeholder="ID (ex: bleu)" required>
                <input class="form-control mb-2" id="inputEquipeNom" placeholder="Nom de l'équipe" required>
                <select class="form-select" id="selectEquipeCouleur" required>
                    <option value="primary">Bleu</option>
                    <option value="danger">Rouge</option>
                    <option value="success">Vert</option>
                    <option value="warning">Jaune</option>
                    <option value="info">Cyan</option>
                    <option value="secondary">Gris</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" type="submit">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Combattant -->
<div class="modal fade" id="modalCombattant" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" id="formCombattant">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un combattant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input class="form-control mb-2" id="inputCombattantNom" placeholder="Nom complet" required>
                <select class="form-select mb-2" id="selectCombattantSexe" required>
                    <option value="M">Masculin</option>
                    <option value="F">Féminin</option>
                </select>
                <select class="form-select mb-2" id="selectCombattantPoids" required>
                    <option value="-60">-60 kg</option>
                    <option value="-66">-66 kg</option>
                    <option value="-73">-73 kg</option>
                    <option value="-81">-81 kg</option>
                    <option value="-90">-90 kg</option>
                    <option value="-100">-100 kg</option>
                    <option value="+100">+100 kg</option>
                </select>
                <select class="form-select" id="selectCombattantEquipe" required>
                    <option value="">-- Sélectionner une équipe --</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" type="submit">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<script type="module">
    const listeEquipes = document.getElementById("liste-equipes");
    const listeCombattants = document.getElementById("liste-combattants");
    const selectEquipeFilter = document.getElementById("select-equipes-filter");
    const selectCombattantEquipe = document.getElementById("selectCombattantEquipe");
    const btnAjouterCombattant = document.getElementById("btn-ajouter-combattant");

    async function chargerEquipes() {
        const res = await fetch('/api/equipes');
        const equipes = await res.json();
        listeEquipes.innerHTML = '';
        selectEquipeFilter.innerHTML = '<option value="">-- Sélectionner une équipe --</option>';
        selectCombattantEquipe.innerHTML = '<option value="">-- Sélectionner une équipe --</option>';
        equipes.forEach(eq => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<span><strong>${eq.nom}</strong> (ID: ${eq.id})</span><span class="badge bg-${eq.couleur}">${eq.couleur}</span>`;
            listeEquipes.appendChild(li);

            const opt = new Option(eq.nom, eq.id);
            selectEquipeFilter.add(opt.cloneNode(true));
            selectCombattantEquipe.add(opt);
        });
        btnAjouterCombattant.disabled = equipes.length === 0;
    }

    async function chargerCombattants(equipeId = '') {
        const res = await fetch('/api/combattants');
        const combattants = await res.json();
        listeCombattants.innerHTML = '';
        combattants
            .filter(c => !equipeId || c.equipeId === equipeId)
            .forEach(c => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = `${c.nom} (${c.sexe}, ${c.poids}kg) – Équipe: ${c.equipeId}`;
                listeCombattants.appendChild(li);
            });
    }

    document.getElementById("formEquipe").addEventListener("submit", async e => {
        e.preventDefault();
        const id = document.getElementById("inputEquipeId").value.trim();
        const nom = document.getElementById("inputEquipeNom").value.trim();
        const couleur = document.getElementById("selectEquipeCouleur").value;

        await fetch('/api/equipes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, nom, couleur })
        });
        bootstrap.Modal.getInstance(document.getElementById("modalEquipe")).hide();
        e.target.reset();
        chargerEquipes();
    });

    document.getElementById("formCombattant").addEventListener("submit", async e => {
        e.preventDefault();
        const nom = document.getElementById("inputCombattantNom").value.trim();
        const sexe = document.getElementById("selectCombattantSexe").value;
        const poids = document.getElementById("selectCombattantPoids").value;
        const equipeId = document.getElementById("selectCombattantEquipe").value;

        await fetch('/api/combattants', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nom, sexe, poids, equipeId })
        });
        bootstrap.Modal.getInstance(document.getElementById("modalCombattant")).hide();
        e.target.reset();
        chargerCombattants(selectEquipeFilter.value);
    });

    selectEquipeFilter.addEventListener("change", () => {
        chargerCombattants(selectEquipeFilter.value);
    });

    window.addEventListener("DOMContentLoaded", async () => {
        await chargerEquipes();
        await chargerCombattants();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
