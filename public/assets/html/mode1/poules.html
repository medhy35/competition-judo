<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestion des Poules</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { background: #f9f9f9; }
    .card-poule { border-radius: 8px; margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    .poule-title { font-size: 1.3rem; font-weight: bold; }
    .match { padding: 5px 0; border-bottom: 1px solid #ddd; }
    .match:last-child { border-bottom: none; }
    .btn-assigner { font-size: 0.85rem; padding: 3px 6px; }

    /* Couleurs selon état */
    .match-prevu { background-color: #f0f0f0; }      /* gris clair */
    .match-en_cours { background-color: #fff3cd; }  /* jaune */
    .match-termine { background-color: #d4edda; }   /* vert clair */
    .match-non_assigne { background-color: #f8d7da; } /* rouge clair */
  </style>
</head>
<body>
<div class="container py-4">
  <h1 class="text-center mb-4">Gestion des Poules</h1>

  <!-- Formulaire de création -->
  <div class="card p-3 mb-4">
    <h5>Créer des poules</h5>
    <form id="createPoulesForm" class="row g-3">
      <div class="col-md-4">
        <label for="nbPoules" class="form-label">Nombre de poules</label>
        <input type="number" class="form-control" id="nbPoules" min="1" value="2" required />
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Générer</button>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="button" id="resetPoules" class="btn btn-danger w-100">Réinitialiser</button>
      </div>
    </form>
  </div>

  <!-- Zone d'affichage des poules -->
  <div id="poulesContainer" class="row"></div>
</div>

<!-- Modal d'assignation -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-labelledby="assignModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="assignModalLabel">Assigner un combat</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="combatInfo" class="fw-bold text-primary"></p>
        <label for="tatamiSelect" class="form-label">Sélectionner un tatami :</label>
        <select class="form-select" id="tatamiSelect"></select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="confirmAssignBtn">Assigner</button>
      </div>
    </div>
  </div>
</div>

<script>
  const socket = io();
  const poulesContainer = document.getElementById('poulesContainer');
  let equipesMap = {};
  let currentCombatToAssign = null;

  // --- Logger vers logs.json ---
  async function logAction(message, data = {}) {
    await fetch('/api/logs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, data, timestamp: new Date().toISOString() })
    });
    console.log('[LOG]', message, data);
  }

  // --- Charger les équipes ---
  async function loadEquipes() {
    const res = await fetch('/api/equipes');
    const equipes = await res.json();
    equipesMap = {};
    equipes.forEach(eq => { equipesMap[eq.id] = eq.nom; });
    await logAction('Équipes chargées', equipesMap);
  }

  // --- Charger les poules et combats ---
  async function loadPoules() {
    await loadEquipes();
    const [poulesRes, combatsRes] = await Promise.all([
      fetch('/api/poules'),
      fetch('/api/combats')
    ]);

    const poules = await poulesRes.json();
    const combats = await combatsRes.json();

    await logAction('Poules chargées', poules);

    // Enrichir les rencontres avec un statut global
    poules.forEach(poule => {
      poule.rencontres.forEach(rencontre => {
        // Récupérer les combats liés à la rencontre
        const combatsDeRencontre = combats.filter(c => rencontre.combatsIds?.includes(c.id));

        if (combatsDeRencontre.length === 0) {
          rencontre.status = 'non_assigne';
        } else if (combatsDeRencontre.some(c => c.etat === 'en_cours')) {
          rencontre.status = 'en_cours';
        } else if (combatsDeRencontre.every(c => c.etat === 'terminé')) {
          rencontre.status = 'termine';
        } else {
          rencontre.status = 'prevu';
        }

      });
    });


    renderPoules(poules);
  }

  // --- Charger les tatamis ---
  async function loadTatamisInSelect() {
    const select = document.getElementById('tatamiSelect');
    select.innerHTML = '';
    const res = await fetch('/api/tatamis');
    const tatamis = await res.json();
    tatamis.forEach(t => {
      const option = document.createElement('option');
      option.value = t.id;
      option.textContent = `${t.nom} (${t.etat})`;
      select.appendChild(option);
    });
    await logAction('Tatamis disponibles', tatamis);
  }

  // --- Rendu des poules avec coloration ---
  async function renderPoules(poules) {
    // Récupérer tous les combats au préalable (globalement)
    const resCombats = await fetch('/api/combats');
    const combatsGlobal = await resCombats.json();

    poulesContainer.innerHTML = '';
    if (!poules.length) {
      poulesContainer.innerHTML = '<p class="text-center text-muted">Aucune poule générée pour le moment.</p>';
      return;
    }

    poules.forEach(poule => {
      const card = document.createElement('div');
      card.className = 'col-md-6 col-lg-4';

      // Pour chaque rencontre on calcule son statut en fonction des combats
      const rencontresHtml = poule.rencontres.map(rencontre => {
        // Filtrer les combats associés à cette rencontre via combatsIds
        const combatsAssocies = combatsGlobal.filter(c => rencontre.combatsIds && rencontre.combatsIds.includes(c.id));

        console.log('Rencontre:', rencontre.id, 'Combats associés:', combatsAssocies);

        // Calculer le statut global
        let status = 'non_assigné'; // défaut si pas de combats liés
        if (combatsAssocies.length === 0) {
          status = 'non_assigné';
        } else if (combatsAssocies.every(c => c.etat === 'terminé')) {
          status = 'terminé';
        } else if (combatsAssocies.some(c => c.etat === 'en_cours')) {
          status = 'en_cours';
        } else {
          status = 'prévu'; // combats créés mais pas encore commencés
        }

        return `
        <div class="match d-flex justify-content-between align-items-center match-${status}">
          <div>
            <strong>${equipesMap[rencontre.equipeA] || rencontre.equipeA}</strong> vs
            <strong>${equipesMap[rencontre.equipeB] || rencontre.equipeB}</strong>
            <span class="text-muted">${rencontre.resultat ? rencontre.resultat : ''}</span>
          </div>
          <button class="btn btn-sm btn-outline-primary btn-assigner" data-combat="${rencontre.id}">Assigner</button>
        </div>`;
      }).join('');

      card.innerHTML = `
      <div class="card card-poule">
        <div class="card-body">
          <h5 class="poule-title mb-3">${poule.nom}</h5>
          <h6>Équipes</h6>
          <ul class="list-group mb-3">
            ${poule.equipesIds.map(eqId => `<li class="list-group-item">${equipesMap[eqId] || eqId}</li>`).join('')}
          </ul>
          <h6>Rencontres</h6>
          <div class="match-list">${rencontresHtml}</div>
        </div>
      </div>
    `;
      poulesContainer.appendChild(card);
    });

    // Rebinding des events pour les boutons assigner
    document.querySelectorAll('.btn-assigner').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        currentCombatToAssign = e.target.getAttribute('data-combat');
        document.getElementById('combatInfo').textContent = `Combat ID : ${currentCombatToAssign}`;
        await logAction('Combat sélectionné pour assignation', { combatId: currentCombatToAssign });
        await loadTatamisInSelect();
        new bootstrap.Modal(document.getElementById('assignModal')).show();
      });
    });
  }


  // --- Assigner un combat ---
  document.getElementById('confirmAssignBtn').addEventListener('click', async () => {
    const tatamiId = document.getElementById('tatamiSelect').value;
    if (!tatamiId || !currentCombatToAssign) return;

    await logAction('Tentative d\'assignation', { combatId: currentCombatToAssign, tatamiId });

    // Récupérer la rencontre correspondante
    const poules = await fetch('/api/poules').then(r => r.json());
    let match = null;
    let equipeAId, equipeBId;
    poules.forEach(p => {
      const found = p.rencontres.find(r => r.id == currentCombatToAssign);
      if (found) {
        match = found;
        equipeAId = found.equipeA;
        equipeBId = found.equipeB;
      }
    });

    if (!match) {
      alert('Combat introuvable dans les poules.');
      return;
    }
    await logAction('Rencontre trouvée', match);

    // Récupérer les combattants
    const combattants = await fetch('/api/combattants').then(r => r.json());
    const rouges = combattants.filter(c => c.equipeId === equipeAId);
    const bleus  = combattants.filter(c => c.equipeId === equipeBId);
    await logAction('Combattants trouvés', { rouges, bleus });

    const combatsCrees = [];
    for (const cRouge of rouges) {
      const cBleu = bleus.find(b => b.poids === cRouge.poids && b.sexe === cRouge.sexe);
      if (cBleu) {
        const combat = await fetch('/api/combats', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            rouge: { ...cRouge, equipeId: equipeAId },
            bleu:  { ...cBleu,  equipeId: equipeBId },
            etat: 'prévu'
          })
        }).then(r => r.json());
        combatsCrees.push(combat.id);
        await logAction('Combat créé', combat);
      }
    }

    if (!combatsCrees.length) {
      alert('Aucun combat valide généré entre ces équipes.');
      return;
    }

    // Assigner tous les combats générés en une seule fois
    await fetch(`/api/tatamis/${tatamiId}/assigner`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ combatsIds: combatsCrees })
    });
    await logAction('Combats assignés au tatami', { tatamiId, combatsCrees });

    bootstrap.Modal.getInstance(document.getElementById('assignModal')).hide();
    alert(`Assignation terminée : ${combatsCrees.length} combats créés et assignés.`);
    loadPoules();
  });

  // --- Créer des poules ---
  document.getElementById('createPoulesForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const nb = document.getElementById('nbPoules').value;
    await fetch('/api/poules', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nbPoules: nb })
    });
    await logAction('Poules générées', { nbPoules: nb });
    loadPoules();
  });

  // --- Reset des poules ---
  document.getElementById('resetPoules').addEventListener('click', async () => {
    if (confirm('Supprimer toutes les poules ?')) {
      await fetch('/api/poules', { method: 'DELETE' });
      await logAction('Poules supprimées');
      loadPoules();
    }
  });

  // --- WebSocket pour mises à jour en direct ---
  socket.on('poules:update', poules => {
    logAction('Mise à jour reçue via WebSocket', poules);
    renderPoules(poules);
  });

  // Chargement initial
  loadPoules();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
