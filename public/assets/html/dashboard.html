<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Dashboard V4 ‚Äì Judo Comp√©tition Temps R√©el</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
    <style>
        body { overflow-x: hidden; background-color: #f8f9fa; }
        .card-hover:hover { transform: scale(1.02); transition: .3s;}
        .tatami-card { min-width:220px; max-width:260px; }
        .timer { font-size:1.1rem; margin-top:.5rem; font-weight:bold; }
        .combat-feed { max-height:220px; overflow:auto; }
        .combat-item { padding:.5rem; border-bottom:1px solid #ddd; opacity:0; animation:fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { to { opacity:1; } }
        .live-ticker { background:#212529; color:#fff; padding:8px 12px; font-size:0.95rem; white-space: nowrap; overflow: hidden; }
        .live-ticker span { display: inline-block; padding-left: 100%; animation: ticker 25s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">üèÜ Judo Dashboard Live</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navMenu">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="mode1/gestion_equipes_combattants.html"><i class="fa-solid fa-users"></i> √âquipes</a></li>
                <li class="nav-item"><a class="nav-link" href="mode1/gestion.html"><i class="fa-solid fa-user"></i> Combattants</a></li>
                <li class="nav-item"><a class="nav-link" href="mode1/combat_tatamis.html"><i class="fa-solid fa-layer-group"></i> Tatamis & Combats</a></li>
                <li class="nav-item"><a class="nav-link" href="mode1/poules.html"><i class="fa-solid fa-circle-nodes"></i> Poules</a></li>
                <li class="nav-item"><a class="nav-link" href="mode1/tableau.html"><i class="fa-solid fa-sitemap"></i> Tableau</a></li>
                <li class="nav-item"><a class="nav-link" href="config.html"><i class="fa-solid fa-sliders"></i> Config</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- Live Tracker -->
<div class="live-ticker">
    <span id="liveTicker">Bienvenue sur le Dashboard Live ‚Äì Suivi en temps r√©el des combats.</span>
</div>

<div class="container py-4">
    <h1 class="mb-4 text-center">Dashboard Live ‚Äì V4</h1>

    <!-- Statistiques globales -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="card bg-primary text-white text-center card-hover"><div class="card-body"><i class="fa-solid fa-users fa-2x"></i><h5>√âquipes</h5><p id="statEquipes" class="display-6">0</p></div></div></div>
        <div class="col-6 col-md-3"><div class="card bg-success text-white text-center card-hover"><div class="card-body"><i class="fa-solid fa-user fa-2x"></i><h5>Combattants</h5><p id="statCombattants" class="display-6">0</p></div></div></div>
        <div class="col-6 col-md-3"><div class="card bg-warning text-white text-center card-hover"><div class="card-body"><i class="fa-solid fa-swords fa-2x"></i><h5>Combats</h5><p id="statCombats" class="display-6">0</p></div></div></div>
        <div class="col-6 col-md-3"><div class="card bg-danger text-white text-center card-hover"><div class="card-body"><i class="fa-solid fa-square fa-2x"></i><h5>Tatamis</h5><p id="statTatamis" class="display-6">0</p></div></div></div>
    </div>

    <!-- Live Tatamis & Feed -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card card-hover">
                <div class="card-header">Live Tatamis</div>
                <div id="tatamisContainer" class="d-flex flex-wrap gap-3 p-3"></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card card-hover">
                <div class="card-header">Feed Combats R√©cents</div>
                <div id="combatFeed" class="combat-feed p-2"></div>
            </div>
        </div>
    </div>

    <!-- Classement des √©quipes -->
    <div class="row g-4 mb-4">
        <div class="col-md-12">
            <div class="card card-hover p-3">
                <h5>Classement des √©quipes</h5>
                <table class="table table-striped">
                    <thead><tr><th>#</th><th>√âquipe</th><th>Victoires</th><th>Score Global</th></tr></thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="mt-5 text-center text-muted">D√©velopp√© avec ‚ù§Ô∏è ‚Äì version 4.0</footer>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const socket = io();
    let liveTickerMessages = [];

    async function loadStats() {
        const [eqs, ctts, cbs, tams] = await Promise.all([
            fetch('/api/equipes').then(r=>r.json()),
            fetch('/api/combattants').then(r=>r.json()),
            fetch('/api/combats').then(r=>r.json()),
            fetch('/api/tatamis').then(r=>r.json())
        ]);
        document.getElementById('statEquipes').textContent = eqs.length;
        document.getElementById('statCombattants').textContent = ctts.length;
        document.getElementById('statCombats').textContent = cbs.length;
        document.getElementById('statTatamis').textContent = tams.length;
    }

    async function renderTatamis() {
        const tams = await fetch('/api/tatamis').then(r => r.json());
        const container = document.getElementById('tatamisContainer');
        container.innerHTML = '';

        for (let t of tams) {
            const c = await fetch(`/api/tatamis/${t.id}/combat-actuel`).then(r => r.json());
            let content = '<p class="text-muted">Aucun combat</p>';

            if (c) {
                content = `
                <div><strong>${c.rouge.equipe}</strong> (${c.rouge.nom})
                vs <strong>${c.bleu.equipe}</strong> (${c.bleu.nom})</div>
                <div>Score : ${c.rouge.wazari}W/${c.rouge.ippon?'1I':'0I'} - ${c.bleu.wazari}W/${c.bleu.ippon?'1I':'0I'}</div>
                <div class="timer" data-timer="${c.timer}" data-etat="${c.etat}"></div>
            `;
            }

            const card = document.createElement('div');
            card.className = 'card tatami-card';
            card.innerHTML = `<div class="card-header bg-secondary text-white">${t.nom}</div>
                          <div class="card-body text-center">${content}</div>
                          <div class="card-footer text-center"><small>√âtat: ${t.etat}</small></div>`;
            container.append(card);
        }
        startTimers();
    }



    function startTimers() {
        document.querySelectorAll('.timer').forEach(el => {
            const starting = parseInt(el.dataset.timer);
            if (el.dataset.etat === 'en cours') {
                let remain = starting;
                el.textContent = formatTime(remain);
                clearInterval(el._int);
                el._int = setInterval(() => {
                    if (remain > 0) { remain--; el.textContent = formatTime(remain); }
                    else clearInterval(el._int);
                }, 1000);
            } else {
                el.textContent = el.dataset.etat;
            }
        });
    }

    function formatTime(sec) {
        const m = Math.floor(sec/60), s = sec%60;
        return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    async function renderLeaderboard() {
        const eqs = await fetch('/api/equipes').then(r=>r.json());
        eqs.sort((a,b)=> (b.scoreGlobal||0)-(a.scoreGlobal||0));
        document.getElementById('leaderboardBody').innerHTML = eqs.map((e,i)=>
            `<tr><td>${i+1}</td><td>${e.nom}</td><td>${e.victoires||0}</td><td>${e.scoreGlobal||0}</td></tr>`).join('');
    }

    let feedIds = new Set();
    function addCombatToFeed(c) {
        if (feedIds.has(c.id)) return;
        feedIds.add(c.id);

        let winnerTxt = '';
        if (c.etat === 'termin√©') {
            if (c.ipponRouge || c.wazariRouge >= 2) winnerTxt = ` ‚Üí Gagnant: ${c.rouge.nom}`;
            else if (c.ipponBleu || c.wazariBleu >= 2) winnerTxt = ` ‚Üí Gagnant: ${c.bleu.nom}`;
        }

        const div = document.createElement('div');
        div.className = 'combat-item';
        div.innerHTML = `<strong>${c.rouge.nom}</strong> vs <strong>${c.bleu.nom}</strong> [${c.tatami || 'Non assign√©'}] <em>${c.etat}</em> ${winnerTxt}`;
        document.getElementById('combatFeed').prepend(div);
        if (document.getElementById('combatFeed').children.length > 20) {
            document.getElementById('combatFeed').removeChild(document.getElementById('combatFeed').lastChild);
        }
        updateLiveTicker(`${c.rouge.nom} vs ${c.bleu.nom} ${winnerTxt}`);
    }

    function updateLiveTicker(msg) {
        liveTickerMessages.push(msg);
        if (liveTickerMessages.length > 5) liveTickerMessages.shift();
        document.getElementById('liveTicker').innerText = liveTickerMessages.join(' | ');
    }

    ['equipes','combattants','combats','tatamis'].forEach(r => {
        socket.on(`${r}:update`, async (payload) => {
            await loadStats();
            renderTatamis();
            renderLeaderboard();
            if (r==='combats') addCombatToFeed(payload);
        });
    });

    window.addEventListener('DOMContentLoaded', async () => {
        await loadStats();
        renderTatamis();
        renderLeaderboard();
        // Initial feed from ended combats
        const all = await fetch('/api/combats').then(r=>r.json());
        for (let c of all.filter(c=>c.etat==='termin√©').slice(-10)) addCombatToFeed(c);
    });
</script>
</body>
</html>
